/* 
   COLOPHON STYLES
   Targeting Tiptap Editor within .colophon-workspace
*/
.colophon-view-header .view-header-title-container {
    display: none;
}

/* 1. WORKSPACE CONTAINER */
.colophon-workspace {
    background-color: var(--background-primary);
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
}

.colophon-scroll-container {
    display: flex;
    flex: 1;
    justify-content: center;
    overflow-y: auto;
    width: 100%;
    position: relative;
    padding-top: 1rem;
    background-color: var(--background-primary);
    color: var(--text-normal);
}


/* 2. THE EDITOR CANVAS */
.colophon-workspace .ProseMirror {
    /* Layout */
    width: 100%;
    /* Use the variable set by JS, or fallback to 1080px (new default) */
    max-width: var(--colophon-editor-width, 1080px);
    min-height: 100%;
    margin: 0 auto;
    padding: 0 2rem 75vh 2rem;
    /* Top padding 0, Bottom 4rem, Sides 2rem */

    /* Appearance */
    background-color: transparent;
    box-shadow: none;
    outline: none;

    /* Typography Base */
    color: var(--text-normal);
    font-family: var(--font-text-theme), var(--font-text-override);
    font-variant: normal;
    caret-color: var(--text-accent);

    /* Fade in animation */
    opacity: 0;
    animation: fadeIn 0.3s ease-in forwards;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

/* Ensure first element is flush with top */
.colophon-workspace .ProseMirror>*:first-child {
    margin-top: 0 !important;
}

/* Selection Styling */
.colophon-workspace .ProseMirror ::selection {
    background-color: var(--text-selection);
}

/* 3. TYPOGRAPHY */

/* Base Paragraph Reset */
.colophon-workspace .ProseMirror p {
    margin: 0;
    padding: 0;
}

/* Headings Reset */
.colophon-workspace .ProseMirror h1,
.colophon-workspace .ProseMirror h2,
.colophon-workspace .ProseMirror h3,
.colophon-workspace .ProseMirror h4,
.colophon-workspace .ProseMirror h5,
.colophon-workspace .ProseMirror h6 {
    margin: 0;
    padding: 0;
    font-weight: normal;
}

/* Footnotes */
.colophon-workspace .ProseMirror .footnote-list {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--text-muted);
    margin-top: 4rem;
    border-top: 1px solid var(--background-modifier-border);
    padding-top: 1rem;
}

/* Hide Tiptap's default focus outline */
.colophon-workspace .ProseMirror-focused {
    outline: none;
}

/* Subscript and Superscript */
.colophon-workspace .ProseMirror sub,
.colophon-workspace .ProseMirror sup {
    font-size: 0.75em;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

.colophon-workspace .ProseMirror sup {
    top: -0.5em;
}

.colophon-workspace .ProseMirror sub {
    bottom: -0.25em;
}

/* 4. LOADING INDICATOR */
.colophon-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--text-muted);
    font-family: var(--font-interface);
    font-size: 0.9rem;
}

.colophon-loader-spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--text-muted);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* 5. TOOLBAR (Now in View Header) */
.colophon-toolbar {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    padding: 0 10px;
    height: 100%;
    /* Remove background/border as it sits in header */
    background: transparent;
    border: none;
}

/* Container injected into view header */
.view-header-center {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    overflow: visible;
    z-index: 10;
}

.colophon-toolbar-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.colophon-ui-btn {
    background: var(--interactive-normal);
    border: 0;
    color: var(--text-normal);
    padding: 6px 10px;
    border-radius: 100vh;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    height: 32px;
    transition: background 0.1s ease;
}

.colophon-ui-btn:hover {
    background: var(--background-modifier-hover);
}

.colophon-ui-btn.colophon-active {
    background: var(--background-modifier-active-hover);
    color: var(--text-normal);
}

.colophon-ui-btn.colophon-icon-only {
    padding: 0;
    width: 32px;
    margin-right: 8px;
    justify-content: center;
}

.colophon-btn-group {
    display: flex;
    align-items: center;
    overflow: hidden;
}

.colophon-dropdown-trigger {
    min-width: 110px;
    justify-content: space-between;
}

.colophon-color-swatch-container {
    height: 32px;
    width: 32px;
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.colophon-color-swatch {
    width: 18px;
    height: 18px;
    border-radius: 4px;
}

.colophon-add-action {
    background: var(--interactive-accent);
    color: var(--text-on-accent);
    border: none;
}

.colophon-add-action:hover {
    background: var(--interactive-accent-hover);
}

.colophon-dropdown-wrapper {
    position: relative;
    display: inline-block;
}

/* Dropdowns & Menus */
.colophon-dropdown-menu,
.colophon-context-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 4px;
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 12px;
    padding: 6px;
    min-width: 150px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    /* Hidden by default */
}

.colophon-context-menu {
    width: 220px;
    /* Position handled by JS or relative to button? 
       For now, let's assume absolute positioning or relative to parent.
       If appended to toolbar, it might need top/left.
       Actually, in toolbar.js I appended it to button parent? No, to toolbar el.
       I need to position it.
       Let's make it fixed or absolute relative to button.
       CSS alone is hard for absolute positioning relative to a button in a flex row unless button is relative.
       I'll make .ui-btn relative? No, dropdown is child of toolbar.
       I'll update toolbar.js to position it or append to button.
       Wait, I appended dropdown to `row1` (which is flex).
       So `position: absolute` will be relative to `colophon-toolbar` (if relative) or `row1` (if relative).
       Let's make `toolbar-row` relative?
    */
}

.colophon-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    color: var(--text-muted);
}

.colophon-menu-item:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.colophon-menu-item .colophon-drag-handle {
    cursor: grab;
    color: var(--text-faint);
    font-size: 10px;
    letter-spacing: -1px;
}

.colophon-menu-item .colophon-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
}

.colophon-menu-item .colophon-label {
    font-size: 14px;
    flex-grow: 1;
}

/* 6. FOOTNOTE SIDEBAR VIEW */
.colophon-footnote-view {
    padding: 10px;
    height: 100%;
    overflow-y: auto;
    position: relative;
    /* For popover positioning */
}

.colophon-footnote-empty {
    color: var(--text-muted);
    text-align: center;
    margin-top: 20px;
    font-style: italic;
}

.colophon-footnote-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.colophon-footnote-item {
    background-color: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.colophon-footnote-header {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 5px;
}

.colophon-footnote-number {
    font-weight: bold;
    color: var(--text-accent);
}

.colophon-footnote-id {
    font-family: monospace;
    opacity: 0.5;
}

.colophon-footnote-editor {
    width: 100%;
    min-height: 60px;
    resize: none;
    border: 1px solid var(--background-modifier-border);
    border-radius: 4px;
    padding: 8px;
    font-family: var(--font-text-theme), var(--font-text-override);
    font-size: 0.9rem;
    background-color: var(--background-primary);
    color: var(--text-normal);
}

.colophon-footnote-editor:focus {
    border-color: var(--text-accent);
    box-shadow: 0 0 0 2px rgba(var(--text-accent-rgb), 0.2);
}

.colophon-footnote-editor-content {
    font-family: var(--font-text-theme), var(--font-text-override);
}

/* Footnote in text */
.colophon-footnote {
    vertical-align: 0.1rem;
    font-size: 0.9rem;
    color: var(--text-accent);
    line-height: 0;
}

/* Footnote Selection */
.colophon-footnote-editor-content ::selection {
    background-color: var(--text-selection);
}

/* Select Menu */
.colophon-select-container {
    position: relative;
    width: 100%;
}

.colophon-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-normal);
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.1s;
}

.colophon-select-trigger:hover {
    background-color: var(--background-modifier-hover);
}

.colophon-select-icon {
    color: var(--text-muted);
}

.colophon-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background-color: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    margin-top: 4px;
    overflow: hidden;
    padding: 4px;
}

.colophon-select-item {
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-normal);
    transition: background-color 0.1s;
}

.colophon-select-item:hover {
    background-color: var(--background-modifier-hover);
}

.colophon-select-item.is-selected {
    background-color: var(--text-selection);
}

.colophon-popover-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: 4px;
    margin-top: 8px;
    padding-left: 2px;
}

.colophon-popover-label:first-child {
    margin-top: 0;
}

/* 7. WORD COUNT INDICATOR */
.colophon-word-count-indicator {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 4px 12px;
    font-family: var(--font-interface);
    font-size: 0.8rem;
    color: var(--text-muted);
    z-index: 100;
    pointer-events: none;
    /* Let clicks pass through if needed, though it's just display */

    /* Translucent / Glass effect */
    opacity: 0.9;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.colophon-export-margins .colophon-export-margins__grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
    min-width: 240px;
    /* keeps the grid from collapsing in narrow sidebars */
}

.colophon-export-margins__label {
    font-size: 11px;
    line-height: 1.2;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.colophon-export-margins__input {
    width: 100%;
    padding: 6px 8px;
    border-radius: var(--radius-s);
    border: 1px solid var(--background-modifier-border);
    background: var(--background-modifier-form-field);
    color: var(--text-normal);
}

.colophon-export-margins__input:focus {
    outline: none;
    border-color: var(--interactive-accent);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--interactive-accent) 30%, transparent);
}

/* 8. COMMENTS */
.colophon-comment-highlight {
    background-color: rgba(255, 214, 10, 0.3);
    /* Subtle yellow */
    border-bottom: 2px solid rgba(255, 214, 10, 0.5);
    cursor: pointer;
    transition: background-color 0.2s;
}

.colophon-comment-highlight:hover {
    background-color: rgba(255, 214, 10, 0.5);
}

/* Active state (when sidebar card is focused or clicked) */
/* We don't strictly have an .is-active class on the mark yet, 
   but we could add one via decoration or just rely on selection. 
   Tiptap selection is blue by default. 
   We might want to override selection color for comment marks? 
   For now, let's stick to default selection. */

/* Sidebar View */
.colophon-comment-view {
    padding: 10px;
    height: 100%;
    overflow-y: auto;
    background-color: var(--background-secondary);
}

.colophon-comment-empty {
    color: var(--text-muted);
    text-align: center;
    margin-top: 40px;
    font-style: italic;
}

.colophon-comment-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding-bottom: 40px;
}

.colophon-comment-card {
    background-color: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    border-left: 3px solid transparent;
}

.colophon-comment-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-color: var(--interactive-accent);
}

.colophon-comment-card.is-active {
    border-color: var(--interactive-accent);
    border-left-color: var(--interactive-accent);
    box-shadow: 0 0 0 2px rgba(var(--interactive-accent-rgb), 0.1);
}

.colophon-comment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.colophon-comment-author-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.colophon-comment-author {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-normal);
}

.colophon-comment-date {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.colophon-comment-resolve-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    transition: all 0.2s;
}

.colophon-comment-resolve-btn:hover {
    background-color: var(--background-modifier-hover);
    color: var(--interactive-success);
    opacity: 1;
}

.colophon-comment-content {
    width: 100%;
    min-height: 24px;
    resize: none;
    border: none;
    background: transparent;
    font-family: var(--text-normal);
    font-size: 0.95rem;
    color: var(--text-normal);
    padding: 0;
    margin: 4px 0;
    line-height: 1.4;
}

.colophon-comment-content:focus {
    outline: none;
}

/* Replies */
.colophon-comment-replies {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--background-modifier-border);
}

.colophon-comment-reply {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 0.9rem;
}

.colophon-comment-reply-header {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
}

.colophon-comment-reply-content {
    color: var(--text-normal);
    padding-left: 8px;
    border-left: 2px solid var(--background-modifier-border);
}

.colophon-comment-reply-input {
    width: 100%;
    background: var(--background-secondary);
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 6px 10px;
    font-size: 0.85rem;
    margin-top: 8px;
    transition: all 0.2s;
}

.colophon-comment-reply-input:focus {
    background: var(--background-primary);
    border-color: var(--interactive-accent);
    outline: none;
}

/* 9. MAIN LAYOUT (Flex) */
.colophon-main-layout {
    display: flex;
    flex: 1;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* 10. COMMENTS PANEL (In-Editor) */
.colophon-comments-panel {
    width: 0;
    opacity: 0;
    background-color: var(--background-secondary);
    border-left: 0 solid var(--background-modifier-border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.2s ease,
        padding 0.3s ease,
        border-left-width 0.3s ease;
    padding: 0;
    visibility: hidden;
    /* Hide content when closed to prevent focus */
}

.colophon-comments-panel.is-visible {
    width: 300px;
    opacity: 1;
    padding: 10px;
    border-left-width: 1px;
    visibility: visible;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.3s ease 0.1s,
        /* Delay opacity slightly on open */
        padding 0.3s ease,
        border-left-width 0.3s ease,
        visibility 0s linear 0s;
    /* Immediate visibility on open */
}

/* Ensure visibility transitions properly on close */
.colophon-comments-panel:not(.is-visible) {
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.2s ease,
        padding 0.3s ease,
        border-left-width 0.3s ease,
        visibility 0s linear 0.3s;
    /* Delay hiding visibility until width animates */
}

.colophon-comments-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--background-modifier-border);
}

.colophon-comments-panel-title {
    font-weight: 600;
    color: var(--text-normal);
}

/* =========================================
   SCRIPT MODE STYLES
   ========================================= */

/* Root Scope */
.colophon-editor-host.is-script-mode .ProseMirror {
    font-family: 'Courier Prime', 'Courier New', Courier, monospace;
    font-size: 12pt;
    line-height: 1.0;
    /* Single spacing standard */
    color: var(--text-normal);
    max-width: 8.5in;
    /* Standard US Letter width approx */
    padding: 1in 1in 1in 1.5in;
    /* Top, Right, Bottom, Left (1.5" left margin) */
}

/* Paragraph Reset for Script Mode */
.colophon-editor-host.is-script-mode .ProseMirror p {
    margin-bottom: 1em;
    /* Standard spacing */
    min-height: 1em;
}

/* 1. Scene Heading */
.colophon-editor-host.is-script-mode .ProseMirror .script-scene {
    font-weight: bold;
    text-transform: uppercase;
    margin-top: 1em;
    margin-bottom: 1em;
    /* 1.5" Left Margin is default padding */
}

/* 2. Action */
.colophon-editor-host.is-script-mode .ProseMirror .script-action {
    /* Standard Width */
    margin-bottom: 1em;
}

/* 3. Character */
.colophon-editor-host.is-script-mode .ProseMirror .script-character {
    margin-left: 2.0in;
    /* Relative to 1.5" margin -> Total ~3.5" */
    margin-right: 0;
    text-transform: uppercase;
    margin-bottom: 0;
    /* Tight with dialogue */
}

/* 4. Dialogue */
.colophon-editor-host.is-script-mode .ProseMirror .script-dialogue {
    margin-left: 1.0in;
    /* Relative to 1.5" margin -> Total ~2.5" */
    margin-right: 1.0in;
    margin-bottom: 1em;
}

/* 5. Parenthetical */
.colophon-editor-host.is-script-mode .ProseMirror .script-parenthetical {
    margin-left: 1.5in;
    /* Relative to 1.5" margin -> Total ~3.0" */
    margin-right: 1.5in;
    margin-bottom: 0;
}

/* 6. Transition */
.colophon-editor-host.is-script-mode .ProseMirror .script-transition {
    text-align: right;
    margin-right: 0.5in;
    text-transform: uppercase;
    margin-bottom: 1em;
    margin-top: 1em;
}

/* Hide Visual Elements in Script Mode if needed */
.colophon-editor-host.is-script-mode .ProseMirror .footnote-list {
    font-family: var(--font-text-theme);
    /* Keep footnotes readable? Or Courier? */
}

/* Ensure formatting marks are visible in Script Mode */
.colophon-editor-host.is-script-mode .ProseMirror strong {
    font-weight: bold;
}

.colophon-editor-host.is-script-mode .ProseMirror em {
    font-style: italic;
}

.colophon-editor-host.is-script-mode .ProseMirror s {
    text-decoration: line-through;
}

.colophon-editor-host.is-script-mode .ProseMirror u {
    text-decoration: underline;
}